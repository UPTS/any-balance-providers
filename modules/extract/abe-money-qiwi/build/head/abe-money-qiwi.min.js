var g_headers={Accept:"application/vnd.qiwi.sso-v1+json",Origin:"https://w.qiwi.com","Accept-Language":"ru;q=0.8,en-US;q=0.6,en;q=0.4","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/43.0.2357.132 Safari/537.36","Content-Type":"application/json"};
function login(a){AnyBalance.setDefaultCharset("utf-8");a=AnyBalance.getPreferences();checkEmpty(a.login,"Введите номер телефона!");checkEmpty(a.password,"Введите пароль!");AnyBalance.requestGet(baseurl+"payment/main.action");var b=a.login;/^\d{10}$/i.test(a.login)?b="+7"+a.login:/^\s*\+/.test(a.login)||(b="+"+a.login);a=requestAPI({action:"cas/tgts",isAuth:!0},{login:b,password:a.password});a=requestAPI({action:"cas/sts",isAuth:!0},{ticket:a.entity.ticket,service:baseurl+"j_spring_cas_security_check"});
a=AnyBalance.requestGet(baseurl+"j_spring_cas_security_check?ticket="+a.entity.ticket,addHeaders({Referer:baseurl}));if(/Внимание! Срок действия вашего пароля истек/i.test(a))throw new AnyBalance.Error("Внимание! Срок действия вашего пароля истек. Зайдите в кошелек через браузер и следуйте инструкции.",null,!0);AnyBalance.trace("Успешно вошли...");return a}
function getAccountInfo(a,b){getParam(a.data.person,b,"user_acc");getParam(a.data.messages,b,"messages");getParam(a.data.unpaidOrderCount,b,"bills");AnyBalance.isAvailable("megafon_balance","megafon_can_pay")&&(html=AnyBalance.requestPost(baseurl+"user/megafon/content/balanceheader.action",{},addHeaders({Accept:"text/html, */*; q=0.01","X-Requested-With":"XMLHttpRequest"})),getParam(html,b,"megafon_balance",/phone-amount[^>]*>([\s\S]*?)<\/div/i,replaceTagsAndSpaces,parseBalance),getParam(html,b,"megafon_can_pay",
/current_amount[^>]*>([\s\S]*?)<\/div/i,replaceTagsAndSpaces,parseBalance));AnyBalance.isAvailable("qvc_card")&&(html=AnyBalance.requestGet(baseurl+"qvc/main.action"),getParam(html,b,"qvc_card",/Номер карты:([^>]*>){3}/i,replaceTagsAndSpaces,html_entity_decode),getParam(html,b,"qvc_exp",/Срок действия:([^>]*>){3}/i,replaceTagsAndSpaces,parseDate))}var baseurlAuth="https://auth.qiwi.com/",baseurl="https://qiwi.com/";
function requestAPI(a,b,c){b=AnyBalance.requestPost(a.isAuth?baseurlAuth+a.action:baseurl+a.action,JSON.stringify(b),c?addHeaders(g_headers,c):g_headers);AnyBalance.trace("Request result: "+b);c=getJson(b);if(a.isAuth){if(!c.entity||!c.entity.ticket){if(c.entity&&(a=c.entity.error.message))throw new AnyBalance.Error(a,null,/Неверный логин или пароль|Неправильный номер телефона или пароль/i.test(a));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось войти в Qiwi Visa Wallet, сайт изменен?");
}}else if(!c.data){if(a=c.message)throw new AnyBalance.Error("Сайт qiwi.ru сообщает: "+a+". Попробуйте обновить данные позже.");AnyBalance.trace(b);throw new AnyBalance.Error("Ошибка при обработке запроса к API!");}return c}var g_currency={RUB:"р",USD:"$",EUR:"€",KZT:"〒",UAH:"₴"};function parseCurrencyMy(a){a=parseCurrency(a);return g_currency[a]?" "+g_currency[a]:a}
function processAccounts(a){var b=requestAPI({action:"person/state.action"},{},{Accept:"application/json, text/javascript","X-Requested-With":"XMLHttpRequest"});a.accounts=[];var c=0,d;for(d in g_currency)if(isset(b.data.balances[d])){var e=d,f={__id:e,__name:e};__shouldProcess("accounts",f)&&processAccount(b.data.balances,e,f);a.accounts.push(f);c++}AnyBalance.trace("Найдено счетов: "+c);return b}
function processAccount(a,b,c){AnyBalance.trace("Обработка счета "+b);getParam(a[b]+"",c,"accounts.balance",null,replaceTagsAndSpaces,parseBalance);getParam(g_currency[b]+"",c,["accounts.currency","accounts.balance"],null,replaceTagsAndSpaces);processAccountTransactions(b,c)}
function processAccountTransactions(a,b){if(AnyBalance.isAvailable("accounts.transactions")){AnyBalance.trace("Получаем последние операции по счету...");html=AnyBalance.requestGet(baseurl+"report/list.action?daterange=true&start="+getFormattedDate(5)+"&finish="+getFormattedDate(),g_headers);var c=getElement(html,/<div class="reports">/i);if(c){b.transactions=[];c=getElements(c,/<div[^>]*class="[^"]*status_SUCCESS"/ig);AnyBalance.trace("У счета "+a+" найдено транзакций: "+c.length);for(var d={RUB:"руб",
USD:"долл"},e=0;e<c.length;++e){var f={},g=getParam(c[e],null,null,/class="cash"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);(new RegExp(d[a])).test(g)&&(getParam(g_currency[a],f,"accounts.transactions.currency"),getParam(g,f,"accounts.transactions.sum",null,null,parseBalance),getParam(c[e],f,"accounts.transactions.time",/DateWithTransaction[^>]*>((?:[\s\S]*?<\/span){2})/i,replaceTagsAndSpaces,parseDate),getParam(c[e],f,"accounts.transactions.name",/"ProvWithComment"[^>]*>((?:[\s\S]*?<\/div>){2})/i,
replaceTagsAndSpaces,html_entity_decode),getParam(c[e],f,"accounts.transactions.transaction",/Транзакция:[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,html_entity_decode),b.transactions.push(f))}}else AnyBalance.trace(html),AnyBalance.trace("Не удалось найти таблицу операций!")}}
function processTemplates(a){if(AnyBalance.isAvailable("templates")){a.templates=[];html=AnyBalance.requestGet(baseurl+"payment/favorite.action");var b=sumParam(html,null,null,/data-action=['"]open['"][^>]*data-params=['"][^"']+['"][^>]*title=['"][^'"]+['"]/ig);AnyBalance.trace("Найдено шаблонов: "+b.length);for(var c=0;c<b.length;++c){var d=getParam(b[c],null,null,/data-params='([^']+)'/i,replaceTagsAndSpaces,getJson).data.payment,e=getParam(b[c],null,null,/title="([^'""]+)/i,replaceTagsAndSpaces,
html_entity_decode),e={__id:d,__name:e};__shouldProcess("templates",e)&&processTemplate(e,d);a.templates.push(e)}}}
function processTemplate(a,b){try{AnyBalance.trace("Обработка шаблона "+b);html=AnyBalance.requestGet(baseurl+"payment/favorite/open.action?payment="+b);getParam(html,a,"templates.sum",/<input\s+type="hidden"\s+name="amount"\s+value="([^"]+)/i,replaceTagsAndSpaces,parseBalance);var c=getParam(html,null,null,/<div\s+data-widget="payment-form"\s+data-params='([^']+)/i,replaceTagsAndSpaces,getJson);if(!c)throw new AnyBalance.Error("Не удалось получить данные по шаблону "+b);getParam(c.provider.id,a,
"templates.prov_id");getParam(c.provider.name,a,"templates.prov_name");var d=sumParam(html,null,null,/<input[^>]*data-title[^>]*class=['"][^"']+dataField[^>]*>/ig);AnyBalance.trace("Найдено полей: "+d.length);a.fields=[];for(c=0;c<d.length;c++){var e=getParam(d[c],null,null,/data-form-field='([^']+)/i,replaceTagsAndSpaces,html_entity_decode),f=getParam(d[c],null,null,/data-title="([^'"]+)/i,replaceTagsAndSpaces),g=getParam(d[c],null,null,/name="([^"]+)/i,replaceTagsAndSpaces),h=getParam(d[c],null,
null,/value="([^"]+)/i,replaceTagsAndSpaces);a.fields.push({name:f,id:g,value:h,extra:e})}}catch(k){AnyBalance.trace(k.message+"\n"+k.stack)}}
function processCards(a,b){a=AnyBalance.requestGet(nodeUrl+"/PhizIC/private/cards/list.do");var c=getElements(a,/<div[^>]+class="productCover[^"]*activeProduct[^>]*">/ig);AnyBalance.trace("Найдено карт: "+c.length);b.cards=[];for(var d=0;d<c.length;++d){var e=getParam(c[d],null,null,/<div[^>]+id="card_(\d+)/i),f=getParam(c[d],null,null,/<[^>]*class="accountNumber\b[^"]*">([^<]+)/i,replaceTagsAndSpaces,html_entity_decode),f={__id:e,__name:f};__shouldProcess("cards",f)&&processCard(c[d],e,f);b.cards.push(f)}}
function processCard(a,b,c){AnyBalance.trace("Обработка карты "+b);getParam(a,c,"cards.balance",/overallAmount\b[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,c,"cards.currency cards.balance cards.cash cards.electrocash cards.debt cards.maxlimit".split(" "),/overallAmount\b[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,c,"cards.cardNumber",/<[^>]*class="accountNumber\b[^"]*">([^<,]+)/i,replaceTagsAndSpaces);getParam(a,c,"cards.till",/<[^>]*class="accountNumber\b[^"]*">[^<]+,\s+действует (?:до|по)([^<]+)/i,
replaceTagsAndSpaces,parseDateWord);AnyBalance.isAvailable("cards.userName","cards.cash","cards.electrocash","cards.minpay","cards.minpaydate","cards.maxlimit")&&(a=AnyBalance.requestGet(nodeUrl+"/PhizIC/private/cards/detail.do?id="+b),getParam(a,c,"cards.userName",/Держатель карты:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/,replaceTagsAndSpaces,capitalFirstLetters),getParam(a,c,"cards.cash",/Для снятия наличных:(?:[^>]*>){5}([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance),getParam(a,c,"cards.electrocash",
/для покупок:(?:[^>]*>){5}([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance),getParam(a,c,"cards.minpay",/Обязательный платеж(?:[^>]*>){5}([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance),getParam(a,c,"cards.minpaydate",/Обязательный платеж(?:[^>]*>){7}([\s\S]*?)<\/div>/,replaceTagsAndSpaces,parseDateWord),getParam(a,c,"cards.maxlimit",/Кредитный лимит(?:[^>]*>){5}([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance));processCardLast10Transactions(b,c);processCardTransactions(b,c)}
function processCardTransactions(a,b){if(AnyBalance.isAvailable("cards.transactions")){AnyBalance.trace("Получаем все операции по карте...");var c=AnyBalance.requestGet(nodeUrl+"/PhizIC/private/accounts/print.do?sel=c:"+a+"&fromDateString="+getFormattedDate(5)+"&toDateString="+getFormattedDate(),g_headers);if(/<table(?:[^>]*>){3}\s*Выписка/i.test(c)){b.transactions=[];var d=sumParam(c,null,null,/<tr class="">(?:[^>]*>){15,25}\s*<\/tr>/ig),c=getParam(c,null,null,/Входящий остаток:[^>]*>\s*[\w\s.,-]+([^.]+)/i,
replaceTagsAndSpaces);AnyBalance.trace("У карты "+a+" найдено транзакций: "+d.length);for(var e=0;e<d.length;++e){var f={},g=-1*(getParam(d[e],null,null,/debit([^>]*>){3}/i,replaceTagsAndSpaces,parseBalance)||0),h=getParam(d[e],null,null,/credit([^>]*>){3}/i,replaceTagsAndSpaces,parseBalance)||0;getParam(g+h,f,"cards.transactions.sum");getParam(c,f,"cards.transactions.currency");getParam(d[e],f,"cards.transactions.time",/operationDate([^>]*>){2}/i,replaceTagsAndSpaces,parseDate);getParam(d[e],f,"cards.transactions.orderNum",
/documentNumber([^>]*>){2}/i,replaceTagsAndSpaces,html_entity_decode);getParam(d[e],f,"cards.transactions.correspond",/accNumber([^>]*>){2}/i,replaceTagsAndSpaces,html_entity_decode);getParam(d[e],f,"cards.transactions.name",/operationDate([^>]*>){8}/i,replaceTagsAndSpaces,html_entity_decode);b.transactions.push(f)}b.transactions=sortObject(b.transactions,"time")}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу операций!")}}
function processCardLast10Transactions(a,b){AnyBalance.trace("Получаем последние 10 операций по карте...");html=AnyBalance.requestGet(nodeUrl+"/PhizIC/private/cards/info.do?id="+a);if(/<table[^>]*class="tblInf"/i.test(html)){b.transactions10=[];var c=sumParam(html,null,null,/<tr[^>]*class="ListLine\d+">(?:[^>]*>){6}\s*<\/tr>/ig);AnyBalance.trace("У карты "+a+" найдено транзакций: "+c.length);for(var d=0;d<c.length;++d){var e={};getParam(c[d],e,"cards.transactions10.sum",/([^>]*>){7}/i,replaceTagsAndSpaces,
parseBalance);getParam(c[d],e,"cards.transactions10.currency",/([^>]*>){7}/i,replaceTagsAndSpaces,parseCurrency);getParam(c[d],e,"cards.transactions10.name",/([^>]*>){3}/i,replaceTagsAndSpaces,html_entity_decode);getParam(c[d],e,"cards.transactions10.time",/([^>]*>){5}/i,replaceTagsAndSpaces,parseSmallDate);b.transactions10.push(e)}b.transactions10=sortObject(b.transactions10,"time")}else AnyBalance.trace(html),AnyBalance.trace("Не удалось найти таблицу операций!")}
function sortObject(a,b){return a.sort(function(a,d){return a[b]>d[b]?-1:a[b]<d[b]?1:0})}function getFormattedDate(a){var b=new Date,c=10>b.getDate()?"0"+b.getDate():b.getDate(),d=10>b.getMonth()+1?"0"+(b.getMonth()+1):b.getMonth()+1;a=isset(a)?b.getFullYear()-a:b.getFullYear();return c+"."+d+"."+a}function getParamByName(a,b){return getParam(a,null,null,new RegExp("name=[\"']"+b+'["\'][^>]*value=["\']([^"\']+)"',"i"))}
function parseSmallDate(a){var b=parseSmallDateInternal(a);AnyBalance.trace("Parsed small date "+new Date(b)+" from "+a);return b}
function parseSmallDateInternal(a){var b=a.match(/(\d+):(\d+)/)||[,0,0],c=new Date;if(/сегодня/i.test(a))return b=new Date(c.getFullYear(),c.getMonth(),c.getDate(),+b[1],+b[2],0),b.getTime();if(/вчера/i.test(a))return b=new Date(c.getFullYear(),c.getMonth(),c.getDate()-1,+b[1],+b[2],0),b.getTime();if(b=/(\d+)[^\d]+(\d+)/i.exec(a))return a=c.getFullYear(),c.getMonth()+1<+b[2]&&--a,b=new Date(a,+b[2]-1,+b[1]),b.getTime();AnyBalance.trace("Не удалось распарсить дату: "+a)};
